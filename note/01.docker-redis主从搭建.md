### centos 安装 docker
1. 更新update到最新的版本
```
yum  update 
```

2. 卸载老版本docker
```
yum  remove docker  docker-common docker-selinux  docker-engine
```
3. 安装需要的软件包
```
yum install -y yum-utils  device-mapper-persistent-data lvm2
```
4. 设置yum源
```
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
```
5. 查看docker版本
```
 yum list docker-ce --showduplicates|sort -r 
``` 
6. 安装docker
```
yum  install  docker-ce-18.03.1.ce -y
```
7. 启动docker
```
systemctl start docker
```
8. 加入开机自启
```
systemctl enable docker
```
9. 配置国内镜像
```
vi /etc/docker/daemon.json 
{
    "registry-mirrors": ["http://hub-mirror.c.163.com"]
}
```
#### docker 基础
```
docker stop  $(docker ps -a -q)
docker rm  $(docker ps -a -q) 
```

### redis主从集群规划

|容器名称 | 容器IP地址 |映射端口号|宿主机IP地址|服务运行模式|
|--- | --- | -- | --- | --|
| redis-master |	172.10.0.2|	6380 -> 6379|	49.234.232.49|Master|
| redis-slave |172.10.0.3|6381 -> 6379|	49.234.232.49|Slave |
#### 容器网络
docker 安装后会默认创建三种网络类型
```
[root@VM_0_17_centos ~]# docker network ls
NETWORK ID          NAME                         DRIVER              SCOPE
285888a72f41        bridge                       bridge              local
d4dde646ef4c        host                         host                local
6f8bafd8bf44        none                         null                local
```
在启动容器时使用  --network bridge 指定网络类型
- bridge：桥接网络 =>
默认情况下启动的Docker容器，都是使用 bridge，Docker安装时创建的桥接网络，每次Docker容器重启时，会按照顺序获取对应的IP地址，这个就导致重启下，Docker的IP地址就变了
- none：无指定网络=> 使用 --network=none ，docker 容器就不会分配局域网的IP
- host： 主机网络=> 使用 --network=host，此时，Docker 容器的网络会附属在主机上，两者是互通的。
例如，在容器中运行一个Web服务，监听8080端口，则主机的8080端口就会自动映射到容器中
#### 指定自定义网络
因为默认的网络不能制定固定的地址，所以我们将创建自定义网络，并指定网段：172.10.0.0/16 并命名为mynetwork，指令
如下：
```
docker network create  --subnet=172.10.0.0/16  mynetwork
```
#### 创建dockerfile
```
FROM centos:latest
RUN groupadd -r redis && useradd  -r -g redis redis
RUN yum -y update &&  yum -y install epel-release && yum -y install redis && yum -y install net-tools
EXPOSE 6379
```
#### 生成镜像
在Dockerfile 目录执行以下命令
```
docker build -t redis-test  .
#docker images查看生成的镜像
```
#### 创建容器
```
docker run -itd --name  redis-master  --net mynetwork  -p 6380:6379  --ip 172.10.0.2  redis 
```
可参考 http://www.dockerinfo.net/docker%E5%AE%B9%E5%99%A8-2
```
-d: 后台运行容器，并返回容器ID；
-i: 以交互模式运行容器，通常与 -t 同时使用；
-p: 端口映射，格式为：主机(宿主)端口:容器端口
-t: 为容器重新分配一个伪输入终端，通常与 -i 同时使用；
--ip: 为容器制定一个固定的ip 
--net: 指定网络模式
```
查看容器
```
docker ps 
docker ps -a
docker inspect mynetwork  #查看容器的ip地址
```
### 配置主从
1. 建立节点
```
#主节点
docker run -itd  --name  redis-master  --net mynetwork  -p 6380:6379  --ip 172.10.0.2  redis 

# 从节点
docker run -itd  --name  redis-slave1  --net mynetwork  -p 6381:6379  --ip 172.10.0.3  redis
```
2. 进入redis-master 启动redis
```
docker exec -it redis-master bash
```
修改配置文件
```
vi /etc/redis.conf

bind 0.0.0.0 #修改bind的ip
protected-mode no #关闭保护模式
requirepass 123456 # 设置密码
```
3. 进入redis-slave 启动redis
```
docker exec -it redis-master bash
```
修改配置文件
```
bind 0.0.0.0 #修改bind的ip
protected-mode no #关闭保护模式
requirepass 123456 # 设置密码
slaveof 49.234.232.49 6380 #主节点IP端口，这里我写的外网地址
masterauth 123456 #主节点密码
```
4. 测试
```
#主节点
127.0.0.1:6379> set aaa 123456
OK
#从节点
127.0.0.1:6379> get aaa
"123456"
```



